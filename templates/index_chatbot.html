<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹˜ì¦ˆğŸ§€ ~ë ˆì‹œí”¼ ì±—ë´‡~ </title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ë³€ìˆ˜ ì •ì˜: ë…¸ë€ìƒ‰ ê³„ì—´ ìœ ì§€ */
        :root {
            --primary-color: #ffc107; /* ë…¸ë€ìƒ‰ (ì•°ë²„) */
            --accent-color: #ff9800; /* ê°•ì¡°ìƒ‰ (ì˜¤ë Œì§€) */
            --bg-color: #fff8e1; /* ë§¤ìš° ì—°í•œ ë…¸ë€ ë°°ê²½ìƒ‰ */
            --text-color: #333;
            --chat-bg-color: #ffffff;
            --user-bubble-bg: #fffbe0; /* ì‚¬ìš©ì ë§í’ì„  ë°°ê²½ (ì—°í•œ ë…¸ë€ìƒ‰) */
            --ai-bubble-bg: #f5f5f5; /* AI ë§í’ì„  ë°°ê²½ */
            --border-color: #ffecb3;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .chat-container {
            width: 100%;
            max-width: 700px;
            background: var(--chat-bg-color);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 80vh; /* í™”ë©´ í¬ê¸°ì— ë§ê²Œ ì¡°ì • */
        }

        .chat-header {
            background-color: var(--primary-color);
            color: var(--text-color);
            padding: 20px;
            text-align: center;
            font-size: 1.6em;
            font-weight: 700;
            border-bottom: 2px solid var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-header span.status-indicator {
            margin-left: 10px;
            font-size: 0.8em;
            font-weight: 500;
            background-color: #ffe082;
            padding: 4px 8px;
            border-radius: 12px;
        }

        /* ì´ˆê¸° ì—°ê²° ì„¤ì • í™”ë©´ ìŠ¤íƒ€ì¼ */
        #connection-setup {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
        }
        #connection-setup h2 {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 20px;
        }

        /* ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ ìŠ¤íƒ€ì¼ */
        #chat-interface {
            flex-grow: 1;
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            flex-direction: column;
        }

        .input-group {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }

        input[type="text"] {
            flex-grow: 1;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="text"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.3);
            outline: none;
        }

        button {
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.1s;
        }
        button:hover {
            background-color: var(--accent-color);
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            color: #777;
        }

        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #fcfcfc;
            display: flex;
            flex-direction: column;
        }

        /* ë©”ì‹œì§€ ë²„ë¸” ìŠ¤íƒ€ì¼ */
        .message-bubble {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-end;
        }
        .message-bubble.user {
            justify-content: flex-end;
        }
        .message-bubble.ai {
            justify-content: flex-start;
        }

        .ai-icon {
            font-size: 24px;
            margin-right: 10px;
            align-self: flex-start;
        }

        .message-content {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 75%;
            word-wrap: break-word;
            font-size: 0.95em;
            line-height: 1.5;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
        }
        .message-bubble.user .message-content {
            background-color: var(--user-bubble-bg);
            color: var(--text-color);
            border-bottom-right-radius: 4px;
        }
        .message-bubble.ai .message-content {
            background-color: var(--ai-bubble-bg);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
        }

        /* íƒ€ì´í•‘ íš¨ê³¼ (ì»¤ì„œ) */
        .message-content.typing::after {
            content: '|';
            animation: blink-caret .75s step-end infinite;
            display: inline-block;
            margin-left: 2px;
        }
        @keyframes blink-caret {
            from, to { opacity: 0 }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            ë ˆì‹œí”¼ ì±—ë´‡ ì¹˜ì¦ˆ<span style="font-size: 22px;">ğŸ§€</span>
            <span id="connectionStatus" class="status-indicator">ì—°ê²° ëŒ€ê¸° ì¤‘</span>
        </div>

        <!-- 1. ì—°ê²° ì„¤ì • í™”ë©´ (ì´ˆê¸° í™”ë©´) -->
        <div id="connection-setup">
            <h2>ğŸ§€ ì¹˜ì¦ˆì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
            <p style="margin-top: 5px; margin-bottom: 10px;"> ì¹˜ì¦ˆëŠ” ì¬ë£Œë¥¼ ì…ë ¥ë°›ì•„ ë ˆì‹œí”¼ë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” ai ì±—ë´‡ì…ë‹ˆë‹¤. ğŸ³</p>
            <p style="margin-top: 5px; margin-bottom: 30px;"> ìœ í†µê¸°í•œì´ ì–¼ë§ˆ ë‚¨ì§€ ì•Šì€ ì¬ë£Œ, ì˜¤ëŠ˜ ë¨¹ê³ ì‹¶ì€ ì¬ë£Œ ë“±ì„ ì…ë ¥í•´ë³´ì„¸ìš”!</p>
            <div style="width: 80%; max-width: 400px;">
                <label for="usernameInput" style="text-align: left; display: block;"> ì´ë¦„ ì…ë ¥:</label>
                <div class="input-group" style="margin-top: 0;">
                    <input type="text" id="usernameInput" value="" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë©€êµ¬)">
                    <button id="connectBtn" onclick="connectWebSocket()">ì—°ê²°</button>
                </div>
            </div>
        </div>

        <!-- 2. ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ (ì—°ê²° ì„±ê³µ í›„ í‘œì‹œ) -->
        <div id="chat-interface">
            <div id="messages">
                <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            <form id="messageForm" class="input-group">
                <input type="text" id="messageInput" placeholder="ì‹ì¬ë£Œë¥¼ ì…ë ¥í•˜ê³  ë ˆì‹œí”¼ë¥¼ ì¶”ì²œë°›ì•„ë³´ì„¸ìš”! (ì˜ˆ: ì–‘íŒŒ, ì¹˜ì¦ˆ)">
                <button type="submit" id="sendBtn" disabled>ì „ì†¡</button>
            </form>
        </div>
    </div>

    <script>
        let ws = null;
        let currentTypingContentElement = null; // í˜„ì¬ íƒ€ì´í•‘ ì¤‘ì¸ ë©”ì‹œì§€ content div
        let isStreaming = false;
        let isImeComposing = false;

        // WebSocket URL ì„¤ì • (í˜„ì¬ ë„ë©”ì¸ ì‚¬ìš©)
        const host = window.location.host;
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const WS_BASE_URL = `${protocol}//${host}/ws`;

        const CHATBOT_NAME = "ì¹˜ì¦ˆ";
        const AI_ICON = "ğŸ§€";

        // DOM ìš”ì†Œ
        const usernameInput = document.getElementById('usernameInput');
        const connectBtn = document.getElementById('connectBtn');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messagesDiv = document.getElementById('messages');
        const connectionSetupDiv = document.getElementById('connection-setup');
        const chatInterfaceDiv = document.getElementById('chat-interface');
        const connectionStatusSpan = document.getElementById('connectionStatus');
        const messageForm = document.getElementById('messageForm'); // FORM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°

        /**
         * ë©”ì‹œì§€ ì˜ì—­ì— ìƒˆë¡œìš´ ë©”ì‹œì§€ ìš”ì†Œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
         * @param {string} text - ë©”ì‹œì§€ ë‚´ìš©
         * @param {'user' | 'ai' | 'status'} type - ë©”ì‹œì§€ íƒ€ì…
         * @param {boolean} isStreamingStart - AI ë©”ì‹œì§€ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘ ì—¬ë¶€
         * @returns {HTMLElement | null} ë©”ì‹œì§€ ë‚´ìš©(content) div
         */
        function appendMessage(text, type, isStreamingStart = false) {
            // ë©”ì‹œì§€ ë²„ë¸” ë˜í¼ ìƒì„±
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble', type);

            // ë©”ì‹œì§€ ë‚´ìš© Div ìƒì„±
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');

            if (type === 'ai') {
                // AI ë©”ì‹œì§€ì¼ ê²½ìš° ì•„ì´ì½˜ ì¶”ê°€
                const iconSpan = document.createElement('span');
                iconSpan.classList.add('ai-icon');
                iconSpan.textContent = AI_ICON;
                messageBubble.appendChild(iconSpan);
            }

            if (isStreamingStart) {
                // ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘ ì‹œ, ë‚´ìš© ì—†ì´ ì»¤ì„œë§Œ ë³´ì´ë„ë¡ ì„¤ì •
                contentDiv.textContent = '';
                contentDiv.classList.add('typing');
                currentTypingContentElement = contentDiv;
            } else {
                // ì¼ë°˜ ë©”ì‹œì§€ëŠ” í…ìŠ¤íŠ¸ ë°”ë¡œ ì¶”ê°€
                contentDiv.textContent = text;
            }

            messageBubble.appendChild(contentDiv);
            messagesDiv.appendChild(messageBubble);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            return contentDiv;
        }

        /**
         * ì±—ë´‡ ì—°ê²°ì„ ì‹œì‘í•˜ê³  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
         */
        function connectWebSocket() {
            const username = usernameInput.value.trim();
            if (!username) {
                alert("ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
                return;
            }

            if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
                return;
            }

            connectBtn.disabled = true;
            usernameInput.disabled = true;

            connectionStatusSpan.textContent = 'ì—°ê²° ì¤‘...';

            ws = new WebSocket(`${WS_BASE_URL}/${username}`);

            ws.onopen = function(event) {
                console.log("WebSocket Connected:", event);
                connectionStatusSpan.textContent = ' ğŸ’¡ ';

                // í™”ë©´ ì „í™˜: ì—°ê²° ì„¤ì • ìˆ¨ê¹€ -> ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ í‘œì‹œ
                connectionSetupDiv.style.display = 'none';
                chatInterfaceDiv.style.display = 'flex';

                messagesDiv.innerHTML = '';

                // ì´ˆê¸° ì¸ì‚¬ë§ (ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘ ì•„ë‹˜)
                appendMessage(`ì•ˆë…•í•˜ì„¸ìš”, ${username}ë‹˜! ì €ëŠ” ë ˆì‹œí”¼ë¥¼ ì•Œë ¤ì£¼ëŠ” ${CHATBOT_NAME}ì…ë‹ˆë‹¤. ì¬ë£Œë¥¼ ì•Œë ¤ì£¼ì‹œë©´ ì£¼ì¬ë£Œë¡œ í•˜ëŠ” 3ê°€ì§€ì˜ ë ˆì‹œí”¼ë¥¼ ì¶”ì²œí•´ ë“œë¦´ê²Œìš”!`, 'ai');

                sendBtn.disabled = false;
                messageInput.focus();
            };

            ws.onmessage = function(event) {
                const data = event.data;

                if (data.includes("--- ë ˆì‹œí”¼ ---")) {
                    isStreaming = true;
                    // ì´ì „ ë©”ì‹œì§€ê°€ ìˆë‹¤ë©´ íƒ€ì´í•‘ íš¨ê³¼ ì œê±°
                    if (currentTypingContentElement) {
                        currentTypingContentElement.classList.remove('typing');
                    }
                    // ìƒˆë¡œìš´ ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ë²„ë¸” ì‹œì‘
                    appendMessage('', 'ai', true);
                    messageInput.disabled = true; // ì‘ë‹µë°›ëŠ” ë™ì•ˆ ì…ë ¥ ë¹„í™œì„±í™”
                    sendBtn.disabled = true;
                    return;
                }

                if (data.includes("--- ë ˆì‹œí”¼ ìƒì„± ì™„ë£Œ ---")) {
                    isStreaming = false;
                    // íƒ€ì´í•‘ íš¨ê³¼ ì¢…ë£Œ (ì»¤ì„œ ì œê±°)
                    if (currentTypingContentElement) {
                        currentTypingContentElement.classList.remove('typing');
                        currentTypingContentElement = null;
                    }
                    // ì…ë ¥ì°½ ë‹¤ì‹œ í™œì„±í™”
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                    messageInput.focus();
                    return;
                }

                // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì¸ ë©”ì‹œì§€ ì²˜ë¦¬
                if (isStreaming && currentTypingContentElement) {
                    // ìˆ˜ì‹ ëœ ì²­í¬ë¥¼ í˜„ì¬ ìš”ì†Œì— ì§ì ‘ ì¶”ê°€ (íƒ€ì´í•‘ íš¨ê³¼)
                    currentTypingContentElement.textContent += data;
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                } else {
                    // ì„œë²„ ì˜¤ë¥˜ ë˜ëŠ” ìˆ˜ì‹  í™•ì¸ ê°™ì€ ë¹„-ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ì²˜ë¦¬
                    appendMessage(data, 'ai');
                }
            };

            ws.onclose = function(event) {
                console.log("WebSocket Disconnected:", event);
                connectionStatusSpan.textContent = ' âŒ ';

                // í™”ë©´ ì „í™˜: ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ ìˆ¨ê¹€ -> ì—°ê²° ì„¤ì • í‘œì‹œ
                chatInterfaceDiv.style.display = 'none';
                connectionSetupDiv.style.display = 'flex';

                appendMessage("âŒ ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì—°ê²°í•´ ì£¼ì„¸ìš”.", 'ai');

                connectBtn.disabled = false;
                usernameInput.disabled = false;
                sendBtn.disabled = true;
                isStreaming = false;
                currentTypingContentElement = null;
            };

            ws.onerror = function(error) {
                console.error("WebSocket Error:", error);
                connectionStatusSpan.textContent = 'ğŸ”´ ì˜¤ë¥˜ ë°œìƒ';
                // oncloseì—ì„œ ëŒ€ë¶€ë¶„ì˜ ì˜¤ë¥˜ ìƒíƒœë¥¼ ì²˜ë¦¬
            };
        }

        /**
         * ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ì„œë²„ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
         */
        function sendMessage() {
            const ingredient = messageInput.value.trim();
            if (!ingredient || isStreaming || !ws || ws.readyState !== WebSocket.OPEN) return;

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            appendMessage(ingredient, 'user');

            // ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡
            ws.send(ingredient);

            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            messageInput.value = '';
        }


        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        // 1. ë©”ì‹œì§€ ì…ë ¥ ì¤‘ IME ìƒíƒœ ê°ì§€
        messageInput.addEventListener('compositionstart', () => {
            isImeComposing = true;
        });
        messageInput.addEventListener('compositionend', () => {
            isImeComposing = false;
        });

        // 2. ë©”ì‹œì§€ í¼ ì œì¶œ ì´ë²¤íŠ¸ (Enter í‚¤ ë˜ëŠ” ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì‹œ)
        messageForm.addEventListener('submit', function(event) {
            event.preventDefault(); // ë¸Œë¼ìš°ì €ì˜ ê¸°ë³¸ í¼ ì œì¶œ(í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨) ë™ì‘ì„ ë§‰ìŠµë‹ˆë‹¤.

            // FIX: IME í•©ì„± ì¤‘ì´ê±°ë‚˜ Enter í‚¤ê°€ ëˆŒë ¸ì„ ë•Œ ì¤‘ë³µ ì „ì†¡ì„ ë§‰ê¸° ìœ„í•´
            // compositionend ì´ë²¤íŠ¸ê°€ ì•„ì§ ë°œìƒí•˜ì§€ ì•Šì•˜ì„ ê²½ìš° ì „ì†¡ì„ ë§‰ìŠµë‹ˆë‹¤.
            if (isImeComposing) {
                // IME í™•ì •ì´ ì™„ë£Œëœ í›„ submit ì´ë²¤íŠ¸ê°€ ë‹¤ì‹œ ë°œìƒí•  ê²ƒì´ë¯€ë¡œ í˜„ì¬ ì „ì†¡ì„ ë§‰ìŒ
                return;
            }

            sendMessage();
        });

        // 3. Enter í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ ì—°ê²° (ì´ë¦„ ì…ë ¥ì°½)
        usernameInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                connectWebSocket();
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì´ë¦„ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
        window.addEventListener('load', () => {
            usernameInput.focus();
        });
    </script>
</body>
</html>